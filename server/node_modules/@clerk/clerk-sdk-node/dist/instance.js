"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// src/instance.ts
var instance_exports = {};
__export(instance_exports, {
  AllowlistIdentifier: () => import_backend3.AllowlistIdentifier,
  Client: () => import_backend3.Client,
  Email: () => import_backend3.Email,
  EmailAddress: () => import_backend3.EmailAddress,
  ExternalAccount: () => import_backend3.ExternalAccount,
  IdentificationLink: () => import_backend3.IdentificationLink,
  Invitation: () => import_backend3.Invitation,
  Organization: () => import_backend3.Organization,
  OrganizationInvitation: () => import_backend3.OrganizationInvitation,
  OrganizationMembership: () => import_backend3.OrganizationMembership,
  OrganizationMembershipPublicUserData: () => import_backend3.OrganizationMembershipPublicUserData,
  PhoneNumber: () => import_backend3.PhoneNumber,
  SMSMessage: () => import_backend3.SMSMessage,
  Session: () => import_backend3.Session,
  User: () => import_backend3.User,
  Verification: () => import_backend3.Verification,
  default: () => instance_default
});
module.exports = __toCommonJS(instance_exports);

// src/clerkClient.ts
var import_backend2 = require("@clerk/backend");

// src/authenticateRequest.ts
var import_backend = require("@clerk/backend");
var import_cookie = __toESM(require("cookie"));
var parseCookies = (req) => {
  return import_cookie.default.parse(req.headers["cookie"] || "");
};
var authenticateRequest = (clerkClient2, apiKey, secretKey, frontendApi, publishableKey, req, options) => {
  const cookies = parseCookies(req);
  const { jwtKey, authorizedParties } = options || {};
  return clerkClient2.authenticateRequest({
    apiKey,
    secretKey,
    frontendApi,
    publishableKey,
    jwtKey,
    authorizedParties,
    cookieToken: cookies[import_backend.constants.Cookies.Session] || "",
    headerToken: req.headers[import_backend.constants.Headers.Authorization]?.replace("Bearer ", "") || "",
    clientUat: cookies[import_backend.constants.Cookies.ClientUat] || "",
    host: req.headers.host,
    forwardedPort: req.headers[import_backend.constants.Headers.ForwardedPort],
    forwardedHost: req.headers[import_backend.constants.Headers.ForwardedHost],
    referrer: req.headers.referer,
    userAgent: req.headers["user-agent"]
  });
};
var handleInterstitialCase = (res, requestState, interstitial) => {
  if (requestState.isInterstitial || requestState.isUnknown) {
    res.writeHead(401, { "Content-Type": "text/html" });
    res.end(interstitial);
  }
};
var decorateResponseWithObservabilityHeaders = (res, requestState) => {
  requestState.message && res.setHeader(import_backend.constants.Headers.AuthMessage, requestState.message);
  requestState.reason && res.setHeader(import_backend.constants.Headers.AuthReason, requestState.reason);
  requestState.status && res.setHeader(import_backend.constants.Headers.AuthStatus, requestState.status);
};

// src/clerkExpressRequireAuth.ts
var createClerkExpressRequireAuth = (createOpts) => {
  const { clerkClient: clerkClient2, frontendApi = "", apiKey = "", secretKey = "", publishableKey = "" } = createOpts;
  return (options = {}) => {
    return async (req, res, next) => {
      const requestState = await authenticateRequest(
        clerkClient2,
        apiKey,
        secretKey,
        frontendApi,
        publishableKey,
        req,
        options
      );
      decorateResponseWithObservabilityHeaders(res, requestState);
      if (requestState.isInterstitial || requestState.isUnknown) {
        const interstitial = await clerkClient2.remotePrivateInterstitial();
        return handleInterstitialCase(res, requestState, interstitial);
      }
      if (requestState.isSignedIn) {
        req.auth = { ...requestState.toAuth(), claims: requestState.toAuth().sessionClaims };
        next();
        return;
      }
      next(new Error("Unauthenticated"));
    };
  };
};

// src/clerkExpressWithAuth.ts
var createClerkExpressWithAuth = (createOpts) => {
  const { clerkClient: clerkClient2, frontendApi = "", apiKey = "", secretKey = "", publishableKey = "" } = createOpts;
  return (options = {}) => {
    return async (req, res, next) => {
      const requestState = await authenticateRequest(
        clerkClient2,
        apiKey,
        secretKey,
        frontendApi,
        publishableKey,
        req,
        options
      );
      decorateResponseWithObservabilityHeaders(res, requestState);
      if (requestState.isInterstitial || requestState.isUnknown) {
        const interstitial = await clerkClient2.remotePrivateInterstitial();
        return handleInterstitialCase(res, requestState, interstitial);
      }
      req.auth = {
        ...requestState.toAuth(),
        claims: requestState.toAuth().sessionClaims
      };
      next();
    };
  };
};

// src/clerkClient.ts
var API_URL = process.env.CLERK_API_URL || "https://api.clerk.dev";
var API_VERSION = process.env.CLERK_API_VERSION || "v1";
var API_KEY = process.env.CLERK_SECRET_KEY || process.env.CLERK_API_KEY || "";
var PUBLISHABLE_KEY = process.env.CLERK_PUBLISHABLE_KEY || "";
function Clerk2(options) {
  const clerkClient2 = (0, import_backend2.Clerk)(options);
  const expressWithAuth = createClerkExpressWithAuth({ ...options, clerkClient: clerkClient2 });
  const expressRequireAuth = createClerkExpressRequireAuth({ ...options, clerkClient: clerkClient2 });
  const verifyToken = (token, verifyOpts) => {
    const issuer = (iss) => iss.startsWith("https://clerk.") || iss.includes(".clerk.accounts");
    return (0, import_backend2.verifyToken)(token, { issuer, ...options, ...verifyOpts });
  };
  return {
    ...clerkClient2,
    expressWithAuth,
    expressRequireAuth,
    verifyToken,
    ...createBasePropForRedwoodCompatibility()
  };
}
var createBasePropForRedwoodCompatibility = () => {
  const verifySessionToken = (token) => {
    const { payload } = (0, import_backend2.decodeJwt)(token);
    return (0, import_backend2.verifyToken)(token, {
      issuer: payload.iss,
      jwtKey: process.env.CLERK_JWT_KEY
    });
  };
  return { base: { verifySessionToken } };
};
var clerkClient = Clerk2({
  apiKey: API_KEY,
  apiUrl: API_URL,
  apiVersion: API_VERSION,
  userAgent: "@clerk/clerk-sdk-node"
});
var ClerkExpressRequireAuth = createClerkExpressRequireAuth({
  clerkClient,
  apiUrl: API_URL,
  apiKey: API_KEY,
  secretKey: API_KEY
});
var ClerkExpressWithAuth = createClerkExpressWithAuth({
  clerkClient,
  apiUrl: API_URL,
  apiKey: API_KEY,
  secretKey: API_KEY
});

// src/instance.ts
var import_backend3 = require("@clerk/backend");
var instance_default = Clerk2;
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  AllowlistIdentifier,
  Client,
  Email,
  EmailAddress,
  ExternalAccount,
  IdentificationLink,
  Invitation,
  Organization,
  OrganizationInvitation,
  OrganizationMembership,
  OrganizationMembershipPublicUserData,
  PhoneNumber,
  SMSMessage,
  Session,
  User,
  Verification
});
//# sourceMappingURL=instance.js.map