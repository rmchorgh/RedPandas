{"version":3,"sources":["../src/instance.ts","../src/clerkClient.ts","../src/authenticateRequest.ts","../src/clerkExpressRequireAuth.ts","../src/clerkExpressWithAuth.ts"],"sourcesContent":["import { Clerk } from './clerkClient';\n\nexport default Clerk;\n\nexport { WithAuthProp, RequireAuthProp } from './types';\n\nexport {\n  AllowlistIdentifier,\n  Client,\n  Email,\n  EmailAddress,\n  ExternalAccount,\n  IdentificationLink,\n  Invitation,\n  Organization,\n  OrganizationInvitation,\n  OrganizationMembership,\n  OrganizationMembershipPublicUserData,\n  PhoneNumber,\n  Session,\n  SMSMessage,\n  User,\n  Verification,\n} from '@clerk/backend';\n","import {\n  Clerk as _Clerk,\n  ClerkOptions,\n  decodeJwt,\n  verifyToken as _verifyToken,\n  VerifyTokenOptions,\n} from '@clerk/backend';\n\nimport { createClerkExpressRequireAuth } from './clerkExpressRequireAuth';\nimport { createClerkExpressWithAuth } from './clerkExpressWithAuth';\n\nexport const API_URL = process.env.CLERK_API_URL || 'https://api.clerk.dev';\nexport const API_VERSION = process.env.CLERK_API_VERSION || 'v1';\nexport const API_KEY = process.env.CLERK_SECRET_KEY || process.env.CLERK_API_KEY || '';\nexport const PUBLISHABLE_KEY = process.env.CLERK_PUBLISHABLE_KEY || '';\n\n/**\n * This needs to be a *named* function in order to support the older\n * new Clerk() syntax for v4 compatibility.\n * Arrow functions can never be called with the new keyword because they do not have the [[Construct]] method\n */\nexport function Clerk(options: ClerkOptions) {\n  const clerkClient = _Clerk(options);\n  const expressWithAuth = createClerkExpressWithAuth({ ...options, clerkClient });\n  const expressRequireAuth = createClerkExpressRequireAuth({ ...options, clerkClient });\n  const verifyToken = (token: string, verifyOpts?: VerifyTokenOptions) => {\n    const issuer = (iss: string) => iss.startsWith('https://clerk.') || iss.includes('.clerk.accounts');\n    return _verifyToken(token, { issuer, ...options, ...verifyOpts });\n  };\n\n  return {\n    ...clerkClient,\n    expressWithAuth,\n    expressRequireAuth,\n    verifyToken,\n    ...createBasePropForRedwoodCompatibility(),\n  };\n}\n\nconst createBasePropForRedwoodCompatibility = () => {\n  const verifySessionToken = (token: string) => {\n    const { payload } = decodeJwt(token);\n    return _verifyToken(token, {\n      issuer: payload.iss,\n      jwtKey: process.env.CLERK_JWT_KEY,\n    });\n  };\n  return { base: { verifySessionToken } };\n};\n\nexport const createClerkClient = Clerk;\n\nexport const clerkClient = Clerk({\n  apiKey: API_KEY,\n  apiUrl: API_URL,\n  apiVersion: API_VERSION,\n  userAgent: '@clerk/clerk-sdk-node',\n});\n\n/**\n * Stand-alone express middlewares bound to the pre-initialised clerkClient\n */\nexport const ClerkExpressRequireAuth = createClerkExpressRequireAuth({\n  clerkClient,\n  apiUrl: API_URL,\n  apiKey: API_KEY,\n  secretKey: API_KEY,\n});\n\nexport const ClerkExpressWithAuth = createClerkExpressWithAuth({\n  clerkClient,\n  apiUrl: API_URL,\n  apiKey: API_KEY,\n  secretKey: API_KEY,\n});\n\n/**\n * Stand-alone setters bound to the pre-initialised clerkClient\n */\nexport const setClerkApiKey = (value: string) => {\n  clerkClient.__unstable_options.apiKey = value;\n};\n\nexport const setClerkServerApiUrl = (value: string) => {\n  clerkClient.__unstable_options.apiUrl = value;\n};\n\nexport const setClerkApiVersion = (value: string) => {\n  clerkClient.__unstable_options.apiVersion = value;\n};\n\nexport const setClerkHttpOptions = (value: RequestInit) => {\n  clerkClient.__unstable_options.httpOptions = value;\n};\n","import { Clerk, constants, RequestState } from '@clerk/backend';\nimport cookie from 'cookie';\nimport { Request as ExpressRequest, Response as ExpressResponse } from 'express';\n\nimport { ClerkMiddlewareOptions } from './types';\n\nconst parseCookies = (req: ExpressRequest) => {\n  return cookie.parse(req.headers['cookie'] || '');\n};\n\nexport const authenticateRequest = (\n  clerkClient: ReturnType<typeof Clerk>,\n  apiKey: string,\n  secretKey: string,\n  frontendApi: string,\n  publishableKey: string,\n  req: ExpressRequest,\n  options?: ClerkMiddlewareOptions,\n) => {\n  const cookies = parseCookies(req);\n  const { jwtKey, authorizedParties } = options || {};\n  return clerkClient.authenticateRequest({\n    apiKey,\n    secretKey,\n    frontendApi,\n    publishableKey,\n    jwtKey,\n    authorizedParties,\n    cookieToken: cookies[constants.Cookies.Session] || '',\n    headerToken: req.headers[constants.Headers.Authorization]?.replace('Bearer ', '') || '',\n    clientUat: cookies[constants.Cookies.ClientUat] || '',\n    host: req.headers.host as string,\n    forwardedPort: req.headers[constants.Headers.ForwardedPort] as string,\n    forwardedHost: req.headers[constants.Headers.ForwardedHost] as string,\n    referrer: req.headers.referer,\n    userAgent: req.headers['user-agent'] as string,\n  });\n};\n\nexport const handleInterstitialCase = (res: ExpressResponse, requestState: RequestState, interstitial: string) => {\n  if (requestState.isInterstitial || requestState.isUnknown) {\n    res.writeHead(401, { 'Content-Type': 'text/html' });\n    res.end(interstitial);\n  }\n};\n\nexport const decorateResponseWithObservabilityHeaders = (res: ExpressResponse, requestState: RequestState) => {\n  requestState.message && res.setHeader(constants.Headers.AuthMessage, requestState.message);\n  requestState.reason && res.setHeader(constants.Headers.AuthReason, requestState.reason);\n  requestState.status && res.setHeader(constants.Headers.AuthStatus, requestState.status);\n};\n","import { Clerk } from '@clerk/backend';\n\nimport {\n  authenticateRequest,\n  decorateResponseWithObservabilityHeaders,\n  handleInterstitialCase,\n} from './authenticateRequest';\nimport type { ClerkMiddlewareOptions, MiddlewareRequireAuthProp, RequireAuthProp } from './types';\n\nexport type CreateClerkExpressMiddlewareOptions = {\n  clerkClient: ReturnType<typeof Clerk>;\n  /**\n   * @deprecated Use `secretKey` instead.\n   */\n  apiKey?: string;\n  /* Secret Key */\n  secretKey?: string;\n  frontendApi?: string;\n  publishableKey?: string;\n  apiUrl?: string;\n};\n\nexport const createClerkExpressRequireAuth = (createOpts: CreateClerkExpressMiddlewareOptions) => {\n  const { clerkClient, frontendApi = '', apiKey = '', secretKey = '', publishableKey = '' } = createOpts;\n\n  return (options: ClerkMiddlewareOptions = {}): MiddlewareRequireAuthProp => {\n    return async (req, res, next) => {\n      const requestState = await authenticateRequest(\n        clerkClient,\n        apiKey,\n        secretKey,\n        frontendApi,\n        publishableKey,\n        req,\n        options,\n      );\n      decorateResponseWithObservabilityHeaders(res, requestState);\n      if (requestState.isInterstitial || requestState.isUnknown) {\n        const interstitial = await clerkClient.remotePrivateInterstitial();\n        return handleInterstitialCase(res, requestState, interstitial);\n      }\n\n      if (requestState.isSignedIn) {\n        (req as RequireAuthProp<any>).auth = { ...requestState.toAuth(), claims: requestState.toAuth().sessionClaims };\n        next();\n        return;\n      }\n\n      next(new Error('Unauthenticated'));\n    };\n  };\n};\n","import {\n  authenticateRequest,\n  decorateResponseWithObservabilityHeaders,\n  handleInterstitialCase,\n} from './authenticateRequest';\nimport { CreateClerkExpressMiddlewareOptions } from './clerkExpressRequireAuth';\nimport type { ClerkMiddlewareOptions, MiddlewareWithAuthProp, WithAuthProp } from './types';\n\nexport const createClerkExpressWithAuth = (createOpts: CreateClerkExpressMiddlewareOptions) => {\n  const { clerkClient, frontendApi = '', apiKey = '', secretKey = '', publishableKey = '' } = createOpts;\n  return (options: ClerkMiddlewareOptions = {}): MiddlewareWithAuthProp => {\n    return async (req, res, next) => {\n      const requestState = await authenticateRequest(\n        clerkClient,\n        apiKey,\n        secretKey,\n        frontendApi,\n        publishableKey,\n        req,\n        options,\n      );\n      decorateResponseWithObservabilityHeaders(res, requestState);\n      if (requestState.isInterstitial || requestState.isUnknown) {\n        const interstitial = await clerkClient.remotePrivateInterstitial();\n        return handleInterstitialCase(res, requestState, interstitial);\n      }\n\n      (req as WithAuthProp<any>).auth = {\n        ...requestState.toAuth(),\n        claims: requestState.toAuth().sessionClaims,\n      };\n      next();\n    };\n  };\n};\n"],"mappings":"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","names":["import_backend","cookie","clerkClient","clerkClient","clerkClient","Clerk","clerkClient","_Clerk","_verifyToken","Clerk","import_backend","Clerk"]}